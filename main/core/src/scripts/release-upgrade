#!/bin/bash

# Preliminary checks
if [ `arch` != "x86_64" ]
then
    echo "Upgrade to Zentyal 5.0 is only supported in 64bit architecture"
    exit 1
fi

if [ $(df /boot | tail -1 | awk '{print $4}') -lt 51200 ];
then
    echo "Upgrade cannot be performed due to low disk space (less than 50MB available on /boot)"
    exit 2
fi

for i in / /var
do
    if [ `df $i | tail -1 | awk '{print $4}'` -lt 358400 ];
    then
        echo -e "Upgrade cannot be performed due to low disk space (less than 350MB available on $i)"
        exit 2
    fi
done

SOURCES=/etc/apt/sources.list
if ! grep -v "^#" $SOURCES | grep -q "ubuntu.com"
then
    echo "deb http://archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse" >> $SOURCES
    echo "deb http://archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse" >> $SOURCES
    echo "deb http://security.ubuntu.com/ubuntu/ trusty-security main restricted universe multiverse" >> $SOURCES
fi

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only $@
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade -y --force-yes -o DPkg::Options::="--force-overwrite" -o DPkg::Options::="--force-confdef" $@
}

LICENSE=""
if [ -f /var/lib/zentyal/.commercial-edition ] && ! [ -f /var/lib/zentyal/.license ]
then
    read -p "Please enter your Zentyal 5.0 license key: " LICENSE
    if wget -q -o /dev/null --user=$LICENSE --password=lk archive.zentyal.com/zentyal-qa/ -O- | grep -q Index
    then
        echo
        echo "License key successfully validated. Upgrade will continue..."
        echo
        echo $LICENSE > /var/lib/zentyal/.license
    else
        echo
        echo "License key cannot be validated."
        echo
        echo "If key is valid please check your connection and run $0 again."
        echo "If you have checked and still have problems, please contact support."
        exit 1
    fi

    echo "Removing deprecated Zentyal Remote package..."
    apt-get remove --purge -y --force-yes -o DPkg::Options::="--force-confdef" zentyal-cloud-prof
fi

sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

# Migrate redis data
stop ebox.redis
service redis-server stop
cp /var/lib/zentyal/dump.rdb /var/lib/redis/dump.rdb
service redis-server start
sed -i 's/redis_port = 6380/redis_port = 6379/' /etc/zentyal/core.conf

# Delete deprecated files
rm -f /etc/cron.d/zentyal-samba
rm -f /etc/apache2/conf.d/ocsmanager.conf
rm -f /etc/apache2/conf-enabled/*ocsmanager*

# Stop services that are going to be deprecated
for i in printers
do
    service zentyal $i stop 2>/dev/null || true
done

#Move the stubs and hooks folder to a safer place so it can be recovered but don't interfere with the upgrade
mv /etc/zentyal/stubs /etc/zentyal/stubs.50upgrade.bak
mv /etc/zentyal/hooks /etc/zentyal/hooks.50upgrade.bak

echo; echo "Upgrading from Ubuntu 14.04 to 16.04 with Zentyal 5.0..."; echo
sed -i 's/trusty/xenial/g' /etc/apt/sources.list
sed -ri '/zentyal(.)4.1/d' /etc/apt/sources.list
sed -ri '/zentyal-packages/d' /etc/apt/sources.list
rm -f /etc/apt/sources.list.d/zentyal*
if [ -n "$LICENSE" ]
then
    ARCHIVE=archive.zentyal.com
    CONF_DIR=/etc/apt/apt.conf.d/
    mkdir -p $CONF_DIR
    cat >> $CONF_DIR/99zentyal <<EOF
Acquire::https::$ARCHIVE {
    Verify-Peer "false";
};
EOF
    echo "deb https://$LICENSE:lk@$ARCHIVE/zentyal-qa 5.0 main" > /etc/apt/sources.list.d/zentyal-qa.list
else
    ARCHIVE=archive.zentyal.org
    echo "deb http://$ARCHIVE/zentyal 5.0 main" > /etc/apt/sources.list.d/zentyal-archive.list
fi

# Workaround to avoid dependency problems when packages are hold
for e in `grep -R "a=zentyal-qa" /etc/apt | cut -f1 -d:`; do rm -f $e; done

cat <<EOF > /etc/apt/preferences
Package: *
Pin: origin "$ARCHIVE"
Pin-Priority: 1002

Package: *
Pin: origin "*.ubuntu.com"
Pin-Priority: 1001
EOF

PACKAGES=""
for pkg in zentyal-samba
do
    if dpkg -l|grep ^ii|grep -q $pkg
    then
        PACKAGES="$pkg $PACKAGES"
    fi
done

upgrade $PACKAGES

rm -f packages.list
rm -f /etc/apt/preferences

# workaround ejabberd and amavisd-new upgrade
rm -f /var/lib/dpkg/info/ejabberd.postinst
rm -f /var/lib/dpkg/info/amavisd-new.postinst

# add dns-$HOSTNAME user to DnsAdmins if exist
if [ -f /usr/bin/samba-tool ] && /usr/bin/samba-tool user list | grep -q "dns-$HOSTNAME"
then
    echo "Adding user dns-$HOSTNAME to DnsAdmins group..."
    samba-tool group addmembers DnsAdmins "dns-$HOSTNAME"
fi

if dpkg --configure -a --force-confdef
then
    # Purge all no longer needed running services
    dpkg -l | grep 'zentyal-' | cut -d' ' -f3 | xargs apt-mark manual
    apt-get autoremove --purge -y --force-yes -o DPkg::Options::="--force-confdef"

    apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"

    dpkg --configure -a --force-confdef

    ## Workaround strange SOGo issue
    SOPE_PACKAGES=$(dpkg -l|grep ^ii|grep sope|cut -d' ' -f3|xargs)
    if [ -n "$SOPE_PACKAGES" ]
    then
        apt-get install --reinstall sogo sogo-activesync $SOPE_PACKAGES
    fi

    ### Migrate SOGo database
    if dpkg -l|grep ^ii|grep sogo
    then
        SOGODB='/usr/share/doc/sogo/sql-update-2.2.17_to_2.3.0-mysql.sh'
        cp echo $SOGODB{,_bk}
        sed -i -e '/^read/d; s/$USER/sogo/g; s/-p/-p$defaultpasswd/g' -e "12idefaultpasswd=`cat /var/lib/zentyal/conf/sogo_db.passwd`" $SOGODB
        if ! ps -ef | grep 'mysqld$'; then service mysql restart; fi
        $SOGODB
    fi

    systemctl enable zentyal

    sed -i 's/net.ifnames=1/net.ifnames=0/g' /etc/default/grub
    update-grub

    # Delete community repo if commercial is activated
    if [ -f /var/lib/zentyal/.license ]
    then
        rm -f /etc/apt/sources.list.d/zentyal-archive.list
    fi

    echo; echo "Zentyal upgrade finished! Please restart your server now."
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
