#!/bin/bash

# Preliminary checks

if [ $(df /boot | tail -1 | awk '{print $4}') -lt 51200 ];
then
    echo "low disk space on /boot"
	exit 2
fi

for i in / /var
do
    if [ `df $i | tail -1 | awk '{print $4}'` -lt 358400 ];
    then
        echo -e "low disk space on $i"
        exit 2
    fi
done

SOURCES=/etc/apt/sources.list
if ! grep -v "^#" $SOURCES | grep -q "ubuntu.com"
then
    echo "deb http://archive.ubuntu.com/ubuntu/ precise main restricted universe multiverse" >> $SOURCES
    echo "deb http://archive.ubuntu.com/ubuntu/ precise-updates main restricted universe multiverse" >> $SOURCES
    echo "deb http://security.ubuntu.com/ubuntu/ precise-security main restricted universe multiverse" >> $SOURCES

fi

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
}

# Prepare for upgrade of commercial edition if it's the case
/usr/share/zentyal/shell '$global->communityEdition() or system("touch /var/lib/zentyal/.commercial-edition")'

LICENSE=""
if [ -f /var/lib/zentyal/.commercial-edition ] && ! [ -f /var/lib/zentyal/.license ]
then
    read -p "Please enter your Zentyal license key: " LICENSE
    if wget -q -o /dev/null --user=$LICENSE --password=lk archive.zentyal.com/zentyal-qa/ -O- | grep -q Index
    then
        echo
        echo "License key successfully validated. Upgrade will continue..."
        echo
        echo $LICENSE > /var/lib/zentyal/.license
    else
        echo
        echo "License key cannot be validated."
        echo
        echo "If key is valid please check your connection and run $0 again."
        echo "If you have checked and still have problems, please contact support."
        exit 1
    fi
fi

echo; echo "Uninstalling packages not supported for the upgrade..."; echo
PACKAGES_TO_CHECK="sogo sogo-openchange sogo-activesync sogo-common zentyal-sogo openchangeserver openchange-ocsmanager openchangeproxy openchange-rpcproxy openchange-notification python-ocsmanager python-mapistore libmapistore0 libmapiproxy0 libmapi0 zentyal-openchange libsope-core4.9 libsope-xml4.9 zentyal-remoteservices zentyal-cloud-prof"
for package in $PACKAGES_TO_CHECK; do
     dpkg -l | grep $package > /dev/null
     if [ $? -eq 0 ]
     then
        PACKAGES_TO_CLEAN="$package $PACKAGES_TO_CLEAN"
     fi
done
apt-get remove --purge -y --force-yes -o DPkg::Options::="--force-confdef" $PACKAGES_TO_CLEAN


sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

echo; echo "Dumping OpenLDAP data..."; echo
# Install samba if missing and replicate users with s4sync
/usr/share/zentyal/migrate-users-to-samba


# Stop services that are going to be deprecated
for i in users remoteservices monitor
do
    service zentyal $i stop
done

#Move the stubs and hooks folder to a safer place so it can be recovered but don't interfere with the upgrade
mv /etc/zentyal/stubs /etc/zentyal/stubs.32upgrade.bak
mv /etc/zentyal/hooks /etc/zentyal/hooks.32upgrade.bak


echo; echo "Upgrading from Ubuntu 12.04 to 14.04 with Zentyal 4.0..."; echo
sed -i 's/precise/trusty/g' /etc/apt/sources.list
sed -ri '/zentyal(.)3.2/d' /etc/apt/sources.list
echo 'deb http://archive.zentyal.org/zentyal 4.0 main extra' > /etc/apt/sources.list.d/zentyal-archive.list
sed -i 's/zentyal-qa-3.2/zentyal-qa-4.0/g' /etc/apt/sources.list.d/zentyal-qa.list

# Workaround to avoid dependency problems when packages are hold
for e in `grep -R "a=zentyal-qa" /etc/apt | cut -f1 -d:`; do rm -f $e; done

apt-get update
upgrade

# Copy samba data to new destination and re-create hardlinks
if dpkg -l | grep -q zentyal-samba
then
    service zentyal samba stop
    pkill -9 samba
    pkill -9 smbd
    mkdir -p /var/lib/samba
    cp -a /opt/samba4/private /var/lib/samba/
    cp -a /opt/samba4/var/locks/* /var/lib/samba/
    ln -f /var/lib/samba/private/sam.ldb.d/DC*FORESTDNSZONES* /var/lib/samba/private/dns/sam.ldb.d/
    ln -f /var/lib/samba/private/sam.ldb.d/DC*DOMAINDNSZONES* /var/lib/samba/private/dns/sam.ldb.d/
    ln -f /var/lib/samba/private/sam.ldb.d/metadata.tdb /var/lib/samba/private/dns/sam.ldb.d/
    chown -R root:bind /var/lib/samba/private/dns
    chmod -R g+rw /var/lib/samba/private/dns
    chmod 0600 /var/lib/samba/private/tls/key.pem
    service zentyal samba restart
fi

for i in `seq 1 5`
do
    echo; echo "Forcing pending packages installation..."; echo
    apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"
    rm -f /var/lib/dpkg/info/suricata.prerm
    for pkg in zentyal-samba freeradius-ldap roundcube-core suricata rabbitmq-server collectd
    do
        rm -f /var/lib/dpkg/info/${pkg}.postinst
    done
    dpkg --configure -a --force-confdef

    rm -f /etc/apt/preferences.d/01zentyal

    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
    if [ $? == 0 ]
    then
        echo; echo "Nothing more pending to upgrade"; echo
        break
    fi
done

if apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
then
    # Purge all no longer needed running services like haproxy, collectd, etc
    dpkg -l | grep 'zentyal-' | cut -d' ' -f3 | xargs apt-mark manual
    apt-get autoremove --purge -y --force-yes -o DPkg::Options::="--force-confdef"

    echo; echo "Importing data from OpenLDAP..."; echo
    stop zentyal.s4sync
    stop smbd
    pkill -9 smbd
    pkill -9 samba
    start samba-ad-dc
    /usr/share/zentyal/global-action --action saveAllModules

    # Restart modules that need to add schemas
    for i in dns samba mail jabber mail mailfilter
    do
        service zentyal $i restart
    done

    /usr/share/zentyal/initial-setup samba 3.2
    service zentyal samba restart > /dev/null 2>&1
    /usr/share/zentyal/initial-setup mail 3.2

    # Restart regular webserver, firewall, Zentyal UI and logs
    service apache2 restart
    service zentyal firewall restart
    service zentyal webadmin restart
    service zentyal logs restart

    echo; echo "Zentyal upgrade finished!"
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
