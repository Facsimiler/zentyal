#!/bin/bash

# Preliminary checks

if [ $(df /boot | tail -1 | awk '{print $4}') -lt 51200 ];
then
    echo "Upgrade cannot be performed due to low disk space (less than 50MB available on /boot)"
    exit 2
fi

for i in / /var
do
    if [ `df $i | tail -1 | awk '{print $4}'` -lt 358400 ];
    then
        echo -e "Upgrade cannot be performed due to low disk space (less than 350MB available on $i)"
        exit 2
    fi
done

SOURCES=/etc/apt/sources.list
if ! grep -v "^#" $SOURCES | grep -q "ubuntu.com"
then
    echo "deb http://archive.ubuntu.com/ubuntu/ bionic main restricted universe multiverse" >> $SOURCES
    echo "deb http://archive.ubuntu.com/ubuntu/ bionic-updates main restricted universe multiverse" >> $SOURCES
    echo "deb http://security.ubuntu.com/ubuntu/ bionic-security main restricted universe multiverse" >> $SOURCES
fi

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --download-only
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade -y -o DPkg::Options::="--force-overwrite" -o DPkg::Options::="--force-confdef"
}

sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

echo; echo "Upgrading from Ubuntu 16.04 to 18.04 with Zentyal 6.0..."; echo
sed -i 's/xenial/bionic/g' /etc/apt/sources.list
sed -ri '/zentyal(.)5.0/d' /etc/apt/sources.list
echo 'deb http://archive.zentyal.org/zentyal 6.0 main' > /etc/apt/sources.list.d/zentyal-archive.list
sed -i 's/zentyal-qa 5.0/zentyal-qa 6.0/g' /etc/apt/sources.list.d/zentyal-qa.list

# workaround redis crash during dist-upgrade
apt-get update
cp /etc/redis/redis.conf /etc/redis/redis.conf.bak
apt-get install -y -o DPkg::Options::="--force-confnew" redis-server
sed -i 's/^bind.*/bind 127.0.0.1/' /etc/redis/redis.conf
dpkg --configure -a
systemctl restart redis-server

upgrade

# workaround ejabberd upgrade
EJABBERD_NODE=$(grep "the database is owned by" /var/log/ejabberd/error.log |tail -1 | sed "s/'//"|rev|cut -d[ -f1|rev|cut -d] -f1)
if [ -z "$EJABBERD_NODE" ]
then
    EJABBERD_NODE="ejabberd@$HOSTNAME"
fi
echo "ERLANG_NODE=$EJABBERD_NODE" >> /etc/ejabberd/ejabberdctl.cfg

# get clamav files if needed
if [ -d /var/lib/clamav ] && ! [ -f /var/lib/clamav/main.cvd ]
then
    freshclam
    zs antivirus restart
fi

rm -f /var/lib/dpkg/info/spamassassin.postinst

dpkg --configure -a --force-confdef

rm -f /var/lib/dpkg/info/ejabberd.postinst

if dpkg --configure -a --force-confdef
then
    systemctl disable lxdm
    systemctl enable zentyal.lxdm

    # Purge all no longer needed running services
    dpkg -l | grep 'zentyal-' | cut -d' ' -f3 | xargs apt-mark manual
    apt-get autoremove --purge -y -o DPkg::Options::="--force-confdef"

    apt-get -f install -y -o DPkg::Options::="--force-confdef"

    dpkg --configure -a --force-confdef

    ### Migrate SOGo database
    if (dpkg -l|grep ^ii|grep -q sogo) > /dev/null 2>&1
    then
        SOGODB='/usr/share/doc/sogo/sql-update-3.2.10_to_4.0.0-mysql.sh'
        cp $SOGODB $SOGODB.bk
        sed -i -e '/^read/d; s/$USER/sogo/g; s/-p/-p$defaultpasswd/g' -e "13idefaultpasswd=`cat /var/lib/zentyal/conf/sogo_db.passwd`" $SOGODB
        if ! ps -ef | grep -q 'mysqld$'; then service mysql restart; fi
        $SOGODB > /dev/null 2>&1
        mv $SOGODB.bk $SOGODB
    fi

    echo; echo "Zentyal upgrade finished! Please restart your server now."

    sleep 2
    pkill -f upgrade-log-server
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
