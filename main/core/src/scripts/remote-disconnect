#!/bin/bash

SLEEP_TIME=300
TRIES=10

THEMEDIR=/tmp/zentyal-theme.bak
mkdir $THEMEDIR
cp /usr/share/zentyal/www/images/title* $THEMEDIR/
cp /usr/share/zentyal/www/custom.theme* $THEMEDIR/

mv /var/lib/dpkg/triggers/zentyal-core $THEMEDIR/

cp -r /var/lib/zentyal/conf/remoteservices/ /var/lib/zentyal/conf/remoteservices.bak

time=2
sleep $time

while lsof /var/lib/dpkg/lock >/dev/null
do
    echo "dpkg is locked, retrying in $time seconds..."
    sleep $time
    time=`expr $time + 1`
done

if ls /var/lib/zentyal/conf/remoteservices/subscription/*/server-info.json >/dev/null
then
    touch /var/lib/zentyal/.commercial-edition
    touch /var/lib/zentyal/.license
fi

rm -f /var/lib/dpkg/info/zentyal-cloud-prof.*rm

success="false"

for try in {1..$TRIES}
do
    dpkg --purge zfilesync zentyal-cloud-prof zentyal-security-updates zentyal-remoteservices
    dpkg --configure -a
    if ! dpkg -l | grep -q zentyal-remoteservices; then
        success="true"
        break
    fi

    echo "Purge of remote packages failed, retrying in $SLEEP_TIME seconds..."
    sleep $SLEEP_TIME
done

if [ "$success" == "false" ]
then
    echo "Uninstall of remote packages failed after $TRIES."
    exit 1
fi

mv /usr/share/zentyal/www/images-3.2/* /usr/share/zentyal/www/images/

cp $THEMEDIR/custom.theme* /usr/share/zentyal/www/
cp $THEMEDIR/title* /usr/share/zentyal/www/images/

/etc/init.d/zentyal webadmin restart

dpkg --configure -a

rm -f /etc/apt/preferences.zentyal* /etc/apt/preferences.d/01zentyal
sed -i 's#qa.cloud.zentyal.com/ zentyal-qa-#archive.zentyal.com/zentyal-qa #' /etc/apt/sources.list.d/zentyal-qa.list
sed -i 's/universe multiverse extra//' /etc/apt/sources.list.d/zentyal-qa.list
echo 'Acquire::https::archive.zentyal.com { Verify-Peer "false"; };' > /etc/apt/apt.conf.d/99zentyal
apt-key add /usr/share/zentyal/zentyal-qa.pub

# This is required only for 3.2
sed -ri '/zentyal(.)3.2/d' /etc/apt/sources.list
sed -ri '/ubuntu.com/d' /etc/apt/sources.list
echo 'deb http://archive.zentyal.org/zentyal 3.2 main extra' > /etc/apt/sources.list.d/zentyal-archive.list

apt-get update

mv $THEMEDIR/zentyal-core /var/lib/dpkg/triggers/zentyal-core

rm -rf $THEMEDIR

echo
echo "Disconnection to Zentyal Remote successfully done."
